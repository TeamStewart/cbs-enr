---
title: "2025 CBS ENR Results"
date: now
date-format: "MMM D HH:mm:ss A z"
format:
  dashboard:
    theme: 
      - default
      - custom.scss
    embed-resources: true
    logo: download.svg
    fig-format: jpeg
    echo: false
    message: false
    warning: false
    keep-md: false
    output-dir: docs
---

```{r setup}

source("scripts/functions.R")

suppressPackageStartupMessages({
  library(targets)
  library(tidyverse)
  library(glue)
  library(gt)
  library(tidymodels)
  library(patchwork)
})

data_VA = merge_data(
  # data = tar_read(data_VA_NA),
  data = read_csv(glue("{PATH_DROPBOX}/25_general/input_data/VA/test_files/VA_2025_11_03_23_58_00.csv")),
  history = tar_read(history_VA_NA),
  office = c("Governor", "Attorney General", "Lt Governor"),
  impute = FALSE
) |>
  add_obs("votes_governor_25_dem_precinct_total", "votes_potus_24_dem")

timestamp_VA = tar_read(timestamp_VA_NA)

# model_VA = tar_read(model_VA_NA)

VA_summary = tar_read(summary_VA_NA) # read this to force `targets()` dependency

VA_summaries = list.files(path = glue("{PATH_DROPBOX}/{ELECTION_FOLDER}/VA/summaries"), full.names = TRUE) |> read_csv()

VA_21 <- read_csv(glue("{PATH_DROPBOX}/25_general/input_data/VA/VA_results_2021_long.csv")) |>
  filter(jurisdiction != 'TOTALS')
```

# Virginia

```{r va_summary}
# Calculate some summary statistics for VA

total_prec = distinct(data_VA, jurisdiction, precinct_id) |> tally() |> pull()
prec_reported = filter(data_VA, obs > 0.25) |> distinct(jurisdiction, precinct_id) |> tally() |> pull()
prec_reported_eday = filter(data_VA, obs > 0.25, vote_mode == "Election Day") |> distinct(jurisdiction, precinct_id) |> tally() |> pull()

total25_dem = pull(data_VA, votes_governor_25_dem_precinct_total) |> sum(na.rm = TRUE)
total25_rep = pull(data_VA, votes_governor_25_rep_precinct_total) |> sum(na.rm = TRUE)
total25_2p = total25_dem + total25_rep
total25 = select(data_VA, starts_with("votes_governor_25")) |> as.matrix() |> sum(na.rm = TRUE)
total25_eday = filter(data_VA, vote_mode == "Election Day") |> select(starts_with("votes_governor_25")) |> as.matrix() |> sum(na.rm = TRUE)

total24_dem = pull(data_VA, votes_potus_24_dem) |> sum(na.rm = TRUE)
total24_rep = pull(data_VA, votes_potus_24_rep) |> sum(na.rm = TRUE)
total24 = select(data_VA, starts_with("votes_potus_24")) |> as.matrix() |> sum(na.rm = TRUE)
total24_eday = filter(data_VA, vote_mode == "Election Day") |> select(starts_with("votes_potus_24")) |> as.matrix() |> sum(na.rm = TRUE)

total21_dem = VA_21 |> summarise(total = sum(precinct_total[candidate_party == 'Democrat'])) |> pull(total)
total21_rep = VA_21 |> summarise(total = sum(precinct_total[candidate_party == 'Republican'])) |> pull(total)
total21 = VA_21 |> summarise(total = sum(precinct_total)) |> pull(total)
total21_eday = VA_21 |> filter(vote_mode == "Election Day") |> summarise(total = sum(precinct_total)) |> pull(total)
```

```{r va_model}
#| cache: true

covars = c('vote_mode', 'age1', 'age2', 'age3', 'white', 'black', 'col')

tests = list.files(
  glue("{PATH_DROPBOX}/25_general/input_data/VA/test_files"),
  pattern = "VA_.*?$",
  full.names = TRUE
)

models = expand_grid(
  method = "lm",
  uncertainty = "conformal",
  subset = c('vote_mode == "Early Voting"', 'vote_mode == "Absentee/Mail"', 'vote_mode == "Election Day"'),
  outcome = c("turnout", "votes_governor_25_dem_precinct_total", "votes_governor_25_rep_precinct_total"),
  c1 = list(NULL, c(covars))
) |>
  rowwise() |>
  mutate(
    c2 = case_when(
      outcome == "votes_governor_25_dem_precinct_total" ~ "votes_potus_24_dem",
      outcome == "votes_governor_25_rep_precinct_total" ~ "votes_potus_24_rep",
      outcome == "turnout" ~ "votes_precFinal_21",
      .default = NA_character_
    ),
    covars = list(c(c2, c1))
  ) |>
  expand_grid(paths = tests) |>
  select(-c1, -c2) |>
  mutate(
    out = pmap(
      list(paths, method, uncertainty, outcome, covars, subset),
      \(data, method, uncertainty, outcome, covars, subset) {
        run_models(
          data = data,
          state = "VA",
          county = NA,
          timestamp = tar_read(timestamp_VA_NA),
          history = tar_read(history_VA_NA),
          covars = covars,
          method = method,
          uncertainty = uncertainty,
          outcome = outcome,
          subset = subset,
          obs_cutoff = 0.25,
          weight_var = "reg24"
        )
      }
    )
  )

summaries = models |>
  mutate(
    out = map(out, "out")
  ) |>
  unnest(cols = out) |>
  summarize(
    across(matches("^(estimate|lower|upper)$"), sum),
    .by = c(method, uncertainty, subset, outcome, covars, vote_mode, timestamp)
  )

```

## Overview {height="15%"}

```{r}
#| content: valuebox
#| title: Last Updated
list(
  value = format(ymd_hms(timestamp_VA, tz = "US/Eastern"), "%b %d %I:%M %p")
)
```

```{r}
#| content: valuebox
#| title: Precincts Reported
list(
  value = paste0(prec_reported, " (", round(100 * prec_reported / total_prec, 1), "%)")
)
```

```{r}
#| content: valuebox
#| title: Total Votes Reported
list(
  value = paste0(prettyNum(total25, big.mark = ","), " (", round(100 * total25 / total21, 1), "% of '21)")
)
```

```{r}
#| content: valuebox
#| title: Total EDay Votes Reported
list(
  value = paste0(prettyNum(total25_eday, big.mark = ","), " (", round(100 * total25_eday / total21_eday, 1), "% of '21)")
)
```

```{r}
#| content: valuebox
#| title: Spanberger Votes Reported
list(
  color = "#005599",
  value = paste0(prettyNum(total25_dem, big.mark = ","), " (", round(100 * total25_dem / total25_2p, 1), "%)", sep = " ")
)
```

```{r}
#| content: valuebox
#| title: Earle-Sears Votes Reported
list(
  color = "#ce0008",
  value = paste0(prettyNum(total25_rep, big.mark = ","), " (", round(100 * total25_rep / total25_2p, 1), "%)", sep = " ")
)
```

## Row
### Time Plots {.tabset}

```{r}
#| title: Total Votes
#| fig-width: 14

total = VA_summaries |>
  summarize(
    turnout = sum(turnout, na.rm = TRUE),
    .by = timestamp
  ) |>
  mutate(vote_mode = 'Total') |>
  ggplot(aes(x = timestamp, y = turnout)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_x_datetime(
    date_breaks = "2 hour",
    labels = scales::label_date(format = "%m-%d \n %I:%M %p", tz = "US/Eastern")
  ) +
  scale_y_continuous(
    labels = scales::label_comma(),
    n.breaks = 7
  ) +
  labs(
    x = "Time (EST)",
    y = "Votes"
  )

mode = VA_summaries |>
  ggplot(aes(x = timestamp, y = turnout)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_x_datetime(
    date_breaks = "2 hour",
    labels = scales::label_date(format = "%m-%d \n %I:%M %p", tz = "US/Eastern")
  ) +
  scale_y_continuous(
    labels = scales::label_comma(),
    n.breaks = 7
  ) +
  scale_color_manual(
    values = c("votes_governor_25_dem_precinct_total" = "#005599", "votes_governor_25_rep_precinct_total" = "#ce0008", "turnout" = "black"),
    labels = c("votes_governor_25_dem_precinct_total" = "Democrat", "votes_governor_25_rep_precinct_total" = "Republican", "turnout" = "Turnout")
  ) +
  labs(
    x = "Time (EST)",
    y = "Votes"
  )

total + mode + 
  plot_layout(guides = 'collect', axis_titles = 'collect', widths = c(1, 3)) & 
  theme(legend.position = 'bottom',axis.text = element_text(size = 16)) &
  scale_y_continuous(
    labels = scales::label_comma(scale_cut = scales::cut_short_scale()),
    n.breaks = 5)
```

```{r}
#| title: Gov Vote Count
#| fig-width: 14

total = VA_summaries |>
  pivot_longer(
    cols = starts_with("votes_governor_25_")
  ) |>
  summarise(
    value = sum(value),
    turnout = sum(turnout),
    .by = c(timestamp, name)
  ) |>
  mutate(vote_mode = 'Total') |>
  ggplot(aes(x = timestamp, y = value, color = name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_color_manual(
    values = c("votes_governor_25_dem_precinct_total" = "#005599", "votes_governor_25_rep_precinct_total" = "#ce0008", "turnout" = "black"),
    labels = c("votes_governor_25_dem_precinct_total" = "Democrat", "votes_governor_25_rep_precinct_total" = "Republican", "turnout" = "Turnout")
  ) +
  labs(
    x = "Time (EST)",
    y = "Votes",
    color = ""
  )


mode = VA_summaries |>
  pivot_longer(
    cols = starts_with("votes_governor_25_")
  ) |>
  ggplot(aes(x = timestamp, y = value, color = name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_color_manual(
    values = c("votes_governor_25_dem_precinct_total" = "#005599", "votes_governor_25_rep_precinct_total" = "#ce0008", "turnout" = "black"),
    labels = c("votes_governor_25_dem_precinct_total" = "Democrat", "votes_governor_25_rep_precinct_total" = "Republican", "turnout" = "Turnout")
  ) +
  labs(
    x = "Time (EST)",
    y = "Votes",
    color = ""
  )

total + mode + 
  plot_layout(guides = 'collect', axis_titles = 'collect', widths = c(1, 3)) & 
  theme(legend.position = 'bottom',axis.text = element_text(size = 16)) &
  scale_x_datetime(
    date_breaks = "2 hour",
    labels = scales::label_date(format = "%m-%d \n %I:%M %p", tz = "US/Eastern")
  ) &
  scale_y_continuous(
    labels = scales::label_comma(scale_cut = scales::cut_short_scale()),
    n.breaks = 5)

```

```{r}
#| title: Gov Vote Share
#| fig-width: 14

total = VA_summaries |>
  pivot_longer(
    cols = starts_with("votes_governor_25_")
  ) |>
  summarise(
    value = sum(value),
    turnout = sum(turnout),
    share = value/turnout,
    .by = c(timestamp, name)
  ) |>
  mutate(
    vote_mode = 'Total',
    ) |>
  ggplot(aes(x = timestamp, y = share, color = name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_color_manual(
    values = c("votes_governor_25_dem_precinct_total" = "#005599", "votes_governor_25_rep_precinct_total" = "#ce0008", "turnout" = "black"),
    labels = c("votes_governor_25_dem_precinct_total" = "Democrat", "votes_governor_25_rep_precinct_total" = "Republican", "turnout" = "Turnout")
  ) +
  labs(
    x = "Time (EST)",
    y = "% of Votes",
    color = ""
  )

mode = VA_summaries |>
  pivot_longer(
    cols = starts_with("votes_governor_25_")
  ) |>
  mutate(
    share = value / sum(value, na.rm = TRUE),
    .by = c(timestamp, vote_mode)
  ) |>
  ggplot(aes(x = timestamp, y = share, color = name)) +
  geom_point() +
  geom_line() +
  facet_wrap(~vote_mode) +
  theme_bw(base_size = 24) +
  scale_color_manual(
    values = c("votes_governor_25_dem_precinct_total" = "#005599", "votes_governor_25_rep_precinct_total" = "#ce0008", "turnout" = "black"),
    labels = c("votes_governor_25_dem_precinct_total" = "Democrat", "votes_governor_25_rep_precinct_total" = "Republican", "turnout" = "Turnout")
  ) +
  labs(
    x = "Time (EST)",
    y = "% of Votes",
    color = ""
  )

total + mode + 
  plot_layout(guides = 'collect', axis_titles = 'collect', widths = c(1, 3)) & 
  theme(legend.position = 'bottom',axis.text = element_text(size = 16)) &
  scale_x_datetime(
    date_breaks = "2 hour",
    labels = scales::label_date(format = "%m-%d \n %I:%M %p", tz = "US/Eastern")
  ) &
  scale_y_continuous(
    labels = scales::label_comma(scale_cut = scales::cut_short_scale()),
    n.breaks = 5)

```

### Share Plots {.tabset}

```{r}
#| title: Margin
#| fig-width: 14

data_VA |>
  filter(obs > 0.25) |>
  mutate(
    across(starts_with("votes_governor_25"), \(x) x / turnout)
  ) |>
  pmargins_hist(votes_governor_25_dem_precinct_total - votes_governor_25_rep_precinct_total) +
  labs(
    x = "Governor Vote Margin (Dem - Rep)"
  )
```

## Forecasting

### VA Vote Modeling {.tabset}
```{r}
#| title: Estimated Vote Count
#| fig-width: 14
total = plot_voteCount(filter(summaries, lengths(covars) == 1, method == "lm", subset != '', uncertainty == "conformal"), uncertainty = TRUE)

mode = plot_voteCount_byMode(filter(summaries, lengths(covars) == 1, method == "lm", subset != '', uncertainty == "conformal"), uncertainty = TRUE)

total + mode + 
  plot_layout(guides = 'collect', axis_titles = 'collect', widths = c(1, 3)) & 
  theme(legend.position = 'bottom',axis.text = element_text(size = 16)) &
  scale_x_datetime(
    date_breaks = "2 hour",
    labels = scales::label_date(format = "%m-%d \n %I:%M %p", tz = "US/Eastern")
  ) &
  scale_y_continuous(
    labels = scales::label_comma(scale_cut = scales::cut_short_scale()),
    n.breaks = 5)
```

```{r}
#| title: Estimated Vote Share
#| fig-width: 14
vote_share_mode = filter(summaries, lengths(covars) == 1, method == "lm", subset != '', uncertainty == "conformal", str_detect(outcome, "dem$|rep$")) |>
  summarize(
    dem_votes = sum(estimate[outcome == "votes_governor_25_dem_precinct_total"]),
    dem_lower = sum(lower[outcome == "votes_governor_25_dem_precinct_total"]),
    dem_upper = sum(upper[outcome == "votes_governor_25_dem_precinct_total"]),
    
    rep_votes = sum(estimate[outcome == "votes_governor_25_rep_precinct_total"]),
    rep_lower = sum(lower[outcome == "votes_governor_25_rep_precinct_total"]),
    rep_upper = sum(upper[outcome == "votes_governor_25_rep_precinct_total"]),
    
    dem_vote_share = dem_votes / (dem_votes + rep_votes),
    dem_vote_share_lower = dem_lower / (dem_lower + rep_upper),
    dem_vote_share_upper = dem_upper / (dem_upper + rep_lower),
    
    rep_vote_share = rep_votes / (dem_votes + rep_votes),
    rep_vote_share_lower = rep_lower / (rep_lower + dem_upper),
    rep_vote_share_upper = rep_upper / (rep_upper + dem_lower),
    
    .by = c(vote_mode, timestamp)
  ) |>
  select(vote_mode, timestamp, contains('vote_share')) |>
  pivot_longer(
    cols = starts_with(c("dem_", "rep_")),
    names_to = c("party", "metric"),
    names_sep = "_vote_"
  ) |>
  pivot_wider(
    names_from = metric,
    values_from = value
  ) |>
  rename(estimate = share, lower = share_lower, upper = share_upper)

vote_share_total = vote_share_mode |>
  summarize(
    dem_votes = sum(estimate[party == "dem"]),
    dem_lower = sum(lower[party == "dem"]),
    dem_upper = sum(upper[party == "dem"]),
    
    rep_votes = sum(estimate[party == "rep"]),
    rep_lower = sum(lower[party == "rep"]),
    rep_upper = sum(upper[party == "rep"]),
    
    dem_vote_share = dem_votes / (dem_votes + rep_votes),
    dem_vote_share_lower = dem_lower / (dem_lower + rep_upper),
    dem_vote_share_upper = dem_upper / (dem_upper + rep_lower),
    
    rep_vote_share = rep_votes / (dem_votes + rep_votes),
    rep_vote_share_lower = rep_lower / (rep_lower + dem_upper),
    rep_vote_share_upper = rep_upper / (rep_upper + dem_lower),
    
    .by = c(timestamp)
  ) |>
  select(timestamp, contains('vote_share')) |>
  pivot_longer(
    cols = starts_with(c("dem_", "rep_")),
    names_to = c("party", "metric"),
    names_sep = "_vote_"
  ) |>
  pivot_wider(
    names_from = metric,
    values_from = value
  ) |>
  rename(estimate = share, lower = share_lower, upper = share_upper) |>
  mutate(vote_mode = 'Total') |>
  select(vote_mode, timestamp, everything())

vote_share = bind_rows(vote_share_mode, vote_share_total) |>
  mutate(vote_mode = factor(vote_mode, levels = c("Total", "Absentee/Mail", "Early Voting", "Election Day")))

plot_voteShare(vote_share, uncertainty = TRUE)
```

### VA Vote Share Overall {.tabset}
```{r}
#| title: Scatter Plot
#| fig-width: 14

```

