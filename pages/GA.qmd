---
title: "Georgia"
---

```{r}

source("scripts/util/globals.R")
source("scripts/models.R")
source("scripts/plotters.R")

suppressPackageStartupMessages({
  library(targets)
  library(tidyverse)
  library(gt)
  library(glue)
  library(fs)
})

inline_hook <- function(x) {
  if (is.numeric(x)) {
    format(x, digits = 2, nsmall = 0, big.mark = ",")
  } else x
}
knitr::knit_hooks$set(inline = inline_hook)

options(scipen = 999)

# load two data sources, current results and historical modeling data
# tar_read(model_GA_NA) |> list2env(envir = .GlobalEnv) |> invisible()

times = read_csv(glue("{PATH_DROPBOX}/22_general/GA_allReports.csv")) |> 
  filter(race_name == "US Senate", timestamp > ymd_hm("2022-11-08 12:00PM", tz = "US/Eastern"), timestamp < ymd("2023-01-01")) |> 
  mutate(
    timestamp = round_date(timestamp, unit = "5 min")
  ) |> 
  distinct(timestamp) |> 
  pull() |> 
  sort()

get_data <- function(time){
  
  read_csv(glue("{PATH_DROPBOX}/22_general/GA_allReports_senate.csv")) |> 
    filter(timestamp <= time, timestamp > ymd("2022-11-06")) |> 
    filter(timestamp == max(timestamp), .by = c(state, jurisdiction, precinct_id)) |>
    select(state, jurisdiction, precinct_id, candidate_name, vote_mode, precinct_total, timestamp) |>
    mutate(
      candidate_name = case_when(
        str_detect(vote_mode, fixed("Undervote", ignore_case=TRUE)) ~ "Undervote",
        str_detect(vote_mode, fixed("Overvote", ignore_case=TRUE)) ~ "Overvote",
        .default = candidate_name
      ),
      vote_mode = case_match(
        vote_mode,
        "Absentee by Mail Votes" ~ "Absentee/Mail",
        "Advance Voting Votes" ~ "Early Voting",
        "Election Day Votes" ~ "Election Day",
        "Provisional Votes" ~ "Provisional",
        .default = NA_character_
      ),
      jurisdiction = str_to_upper(jurisdiction),
      precinct_id = str_to_upper(precinct_id)
    )
  
}

m = get_data(times[75]) |> run_models("GA", "NA", times[75], FALSE)
list2env(m, envir = .GlobalEnv) |> invisible()

```

## How Many Votes Are In?

`r sum(pull(data_history, votes_precTotal_24))` **total** votes are in, `r 100*sum(pull(data_history, votes_precTotal_24)) / sum(pull(data_history, votes_precFinal_20), na.rm=TRUE)`% of the 2020 total

- We estimate the **final total turnout** will be `r summaries$votes_total_24_estimate` with uncertainty bounds [`r summaries$votes_total_24_lower` to `r summaries$votes_total_24_upper`]

`r sum(pull(filter(data_history, vote_mode=="Election Day"), votes_precTotal_24))` **Election Day** votes are in, `r 100*sum(pull(filter(data_history, vote_mode=="Election Day"), votes_precTotal_24)) / sum(pull(filter(data_history, vote_mode=="Election Day"), votes_precFinal_20), na.rm=TRUE)`% of the 2020 total

- We estimate the **final Election Day turnout** will be `r pull(filter(summaries_byMode, vote_mode == "Election Day"), votes_total_24_estimate)` with uncertainty bounds [`r pull(filter(summaries_byMode, vote_mode == "Election Day"), votes_total_24_lower)` to `r pull(filter(summaries_byMode, vote_mode == "Election Day"), votes_total_24_upper)`]

**Precincts reporting all modes**: `r prec_reported_all` out of `r prec_total` total precincts (`r 100*round(prec_reported_all / prec_total, 2)`%)

**Precincts reporting Election Day**: `r prec_reported_eday` out of `r prec_total` total precincts (`r 100*round(prec_reported_eday / prec_total, 2)`%)

## Vote Estimates

**Margin (Harris - Trump)**: `r 100*(summaries$demShare_estimate - summaries$repShare_estimate)`pp with uncertainty bounds [`r 100*(summaries$demShare_lower - summaries$repShare_lower)`pp to `r 100*(summaries$demShare_upper - summaries$repShare_upper)`pp]

**Change in Margin vs 2020**: `r 100*(summaries$swing_estimate)`pp with uncertainty bounds [`r 100*(summaries$swing_lower)`pp to `r 100*(summaries$swing_upper)`pp]

```{r tbl_mode}

summaries_byMode |> 
  mutate(
    across(c(contains("swing")), ~ scales::label_percent(accuracy = 0.01)(.x)),
    swing_24 = glue("{swing_estimate} [{swing_lower} to {swing_upper}]")
  ) |> 
  filter(vote_mode != "Provisional") |> 
  select(vote_mode, swing_24) |> 
  gt() |> 
  tab_style_body(
    style = cell_text(font = "Hack"),
    fn = \(x) TRUE
  ) |>
  cols_align(align = "center") |> 
  cols_label(
    vote_mode = "Vote Mode",
    swing_24 = "Change in Margin vs 2020"
  )

```


**Democrat**: `r summaries$demVotes_estimate` with uncertainty bounds [`r summaries$demVotes_lower` to `r summaries$demVotes_upper`]

**Republican**: `r summaries$repVotes_estimate` with uncertainty bounds [`r summaries$repVotes_lower` to `r summaries$repVotes_upper`]

### Cumulative Plot of Estimated Vote Share (Dem and Rep)

```{r}

tar_read(plot_voteShare_GA_NA)

```

### Cumulative Plot of Margin vs 2020

```{r}

tar_read(plot_margin2020_GA_NA)

```

## Estimated Turnout

### Cumulative Plot of Estimated Election Day Votes

```{r}

tar_read(plot_votesEDay_GA_NA)

```

### Cumulative Plot of Estimated Total Votes

```{r}

tar_read(plot_votesAll_GA_NA)

```


## County-level Results by Mode

```{r tbl_county_mode}

# tar_read(tbl_countyMode_GA_NA)

make_tbl_countyMode(m)

```

## County-level Results

```{r tbl_county}

# tar_read(tbl_county_GA_NA)

make_tbl_county(m)

```


